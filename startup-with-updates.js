// ========================================
// SISTEMA DE INICIALIZA√á√ÉO COM ATUALIZA√á√ïES
// Sistema de Demandas Governan√ßa TOP v2.0.0
// ========================================

const path = require('path');
const { spawn } = require('child_process');
const GitHubUpdateSystem = require('./scripts/github-update-system');
const CorporateDownloader = require('./scripts/corporate-downloader');

console.log('üöÄ INICIANDO SISTEMA DE DEMANDAS...\n');

class SystemStarter {
    constructor() {
        this.githubUpdater = new GitHubUpdateSystem({
            owner: 'kruetzmann2110',
            repo: 'demandas',
            branch: 'main',
            folder: 'releases'
        });
        
        this.corporateDownloader = new CorporateDownloader();
    }

    /**
     * Verificar se h√° atualiza√ß√µes dispon√≠veis
     */
    async verificarAtualizacoes() {
        console.log('üîç VERIFICANDO ATUALIZA√á√ïES...\n');
        
        try {
            // Tentar m√©todo padr√£o primeiro
            let atualizacaoDisponivel = await this.githubUpdater.verificarEAtualizarSistema();
            
            // Se falhou por certificado SSL, tentar m√©todo corporativo
            if (!atualizacaoDisponivel) {
                console.log('\nüè¢ Tentando m√©todo corporativo para ambientes com proxy/firewall...');
                
                const versaoGitHub = await this.corporateDownloader.verificarVersaoGitHub();
                
                if (versaoGitHub) {
                    console.log('‚úÖ Conex√£o via m√©todo corporativo estabelecida!');
                    console.log(`üìã Vers√£o dispon√≠vel: ${versaoGitHub.version}`);
                    
                    // Verificar se precisa atualizar (vers√£o simplificada)
                    const CURRENT_VERSION = '2.0.3';
                    if (versaoGitHub.version !== CURRENT_VERSION) {
                        console.log('üÜï Nova vers√£o dispon√≠vel!');
                        console.log('üìã Para atualizar manualmente, baixe do GitHub: https://github.com/kruetzmann2110/demandas');
                    } else {
                        console.log('‚úÖ Vers√£o atual √© a mais recente');
                    }
                } else {
                    console.log('‚ö†Ô∏è M√©todos de atualiza√ß√£o indispon√≠veis - GitHub pode estar bloqueado');
                }
            }
            
            if (atualizacaoDisponivel) {
                console.log('\n‚úÖ SISTEMA ATUALIZADO COM SUCESSO!');
                console.log('üîÑ REINICIANDO COM NOVA VERS√ÉO...\n');
                
                // Aguardar um pouco antes de reiniciar
                await this.aguardar(2000);
                return true;
            } else {
                console.log('‚úÖ Sistema j√° est√° na vers√£o mais recente!');
                console.log('üöÄ Iniciando servidor...\n');
                return false;
            }
            
        } catch (error) {
            console.error('‚ö†Ô∏è Erro ao verificar atualiza√ß√µes:', error.message);
            console.log('üì± Continuando com vers√£o local...\n');
            return false;
        }
    }

    /**
     * Verificar e instalar depend√™ncias se necess√°rio
     */
    async verificarDependencias() {
        console.log('üîç Verificando depend√™ncias...');
        
        try {
            require('express');
            require('mssql');
            console.log('‚úÖ Depend√™ncias encontradas\n');
            return true;
        } catch (error) {
            console.log('‚ö†Ô∏è Depend√™ncias faltando - instalando automaticamente...');
            
            const { spawn } = require('child_process');
            
            return new Promise((resolve) => {
                const npmInstall = spawn('npm', ['install', 'express', 'mssql'], {
                    stdio: 'inherit',
                    cwd: __dirname
                });
                
                npmInstall.on('close', (code) => {
                    if (code === 0) {
                        console.log('‚úÖ Depend√™ncias instaladas com sucesso!\n');
                        resolve(true);
                    } else {
                        console.log('‚ùå Erro ao instalar depend√™ncias via npm');
                        console.log('üè¢ Tentando instalador corporativo sem Git...');
                        
                        // Fallback para instalador corporativo
                        this.instalarDependenciasCorporativo()
                            .then(sucesso => {
                                if (sucesso) {
                                    console.log('‚úÖ Depend√™ncias instaladas via m√©todo corporativo!\n');
                                    resolve(true);
                                } else {
                                    console.log('‚ùå Falha na instala√ß√£o corporativa');
                                    console.log('üîß SOLU√á√ïES DISPON√çVEIS:');
                                    console.log('   1. Execute: node scripts/instalar-dependencias-corporativo.js');
                                    console.log('   2. Execute: INSTALAR-DEPENDENCIAS-CORPORATIVO.bat');
                                    console.log('   3. Execute: INICIAR-COM-DEPENDENCIAS.bat (recomendado)');
                                    console.log('   4. Veja: SOLUCAO-ERRO-EXPRESS.md para mais detalhes\n');
                                    resolve(false);
                                }
                            });
                    }
                });
                
                npmInstall.on('error', (error) => {
                    console.log('‚ùå Erro ao executar npm install:', error.message);
                    console.log('üè¢ Tentando instalador corporativo sem Git...');
                    
                    // Fallback para instalador corporativo
                    this.instalarDependenciasCorporativo()
                        .then(sucesso => {
                            if (sucesso) {
                                console.log('‚úÖ Depend√™ncias instaladas via m√©todo corporativo!\n');
                                resolve(true);
                            } else {
                                console.log('‚ùå Falha na instala√ß√£o corporativa');
                                console.log('üîß SOLU√á√ïES DISPON√çVEIS:');
                                console.log('   1. Execute: node scripts/instalar-dependencias-corporativo.js');
                                console.log('   2. Execute: INSTALAR-DEPENDENCIAS-CORPORATIVO.bat');
                                console.log('   3. Execute: INICIAR-COM-DEPENDENCIAS.bat (recomendado)');
                                console.log('   4. Veja: SOLUCAO-ERRO-EXPRESS.md para mais detalhes\n');
                                resolve(false);
                            }
                        });
                });
            });
        }
    }

    /**
     * Instalar depend√™ncias usando m√©todo corporativo (sem Git)
     */
    async instalarDependenciasCorporativo() {
        try {
            const DependencyInstaller = require('./scripts/instalar-dependencias-corporativo');
            const installer = new DependencyInstaller();
            return await installer.instalar();
        } catch (error) {
            console.log('‚ùå Erro no instalador corporativo:', error.message);
            return false;
        }
    }

    /**
     * Iniciar o servidor backend
     */
    async iniciarServidor() {
        return new Promise((resolve, reject) => {
            console.log('üéØ INICIANDO SERVIDOR BACKEND...\n');
            
            // Caminho para o servidor
            const serverPath = path.join(__dirname, 'backend', 'server.js');
            
            // Iniciar o processo do servidor com as vari√°veis de ambiente
            const serverProcess = spawn('node', [serverPath], {
                stdio: 'inherit', // Mostrar output do servidor no console atual
                cwd: __dirname,
                env: process.env // Passar todas as vari√°veis de ambiente, incluindo PORT
            });

            // Quando o servidor iniciar
            serverProcess.on('spawn', () => {
                const port = process.env.PORT || 3000;
                console.log('‚úÖ Servidor iniciado com sucesso!');
                console.log('üåê Acesse: http://localhost:' + port);
                console.log('üìä Dashboard: http://localhost:' + port + '/index.html');
                console.log('\nüî• SISTEMA DE DEMANDAS FUNCIONANDO!\n');
                resolve(serverProcess);
            });

            // Se houver erro
            serverProcess.on('error', (error) => {
                console.error('‚ùå Erro ao iniciar servidor:', error.message);
                reject(error);
            });

            // Se o servidor fechar
            serverProcess.on('close', (code) => {
                if (code !== 0) {
                    console.log(`‚ö†Ô∏è Servidor fechou com c√≥digo: ${code}`);
                } else {
                    console.log('‚úÖ Servidor fechado normalmente');
                }
            });

            // Capturar Ctrl+C para fechar graciosamente
            process.on('SIGINT', () => {
                console.log('\nüõë Fechando sistema...');
                serverProcess.kill();
                process.exit(0);
            });
        });
    }

    /**
     * Aguardar um tempo em millisegundos
     */
    async aguardar(ms) {
        return new Promise(resolve => setTimeout(resolve, ms));
    }

    /**
     * Iniciar o sistema completo
     */
    async iniciar() {
        try {
            console.log('========================================');
            console.log('üè¢ SISTEMA DE DEMANDAS GOVERNAN√áA TOP');
            console.log('üìÖ Vers√£o 2.0.3 - Auto Update via GitHub');
            console.log('========================================\n');

            // 1. Verificar atualiza√ß√µes
            const foiAtualizado = await this.verificarAtualizacoes();
            
            if (foiAtualizado) {
                // Se foi atualizado, aguardar um pouco e continuar
                console.log('üîÑ Sistema atualizado! Aguardando e continuando execu√ß√£o...\n');
                await this.aguardar(3000); // Aguardar 3 segundos
                
                // N√£o reiniciar o processo, apenas continuar
                console.log('üöÄ Continuando com vers√£o atualizada...');
            }

            // 2. Verificar depend√™ncias
            const dependenciasOK = await this.verificarDependencias();
            
            if (!dependenciasOK) {
                console.log('‚ùå Depend√™ncias n√£o puderam ser instaladas!');
                console.log('üîß Por favor, execute manualmente um dos seguintes comandos:');
                console.log('   1. node scripts/instalar-dependencias-corporativo.js');
                console.log('   2. INSTALAR-DEPENDENCIAS-CORPORATIVO.bat');
                console.log('   3. npm install express mssql (se tiver acesso ao npm)');
                console.log('\nüõë Sistema n√£o pode iniciar sem as depend√™ncias necess√°rias.');
                process.exit(1);
            }

            // 3. Iniciar servidor normalmente
            await this.iniciarServidor();
            
        } catch (error) {
            console.error('üí• Erro cr√≠tico durante inicializa√ß√£o:', error.message);
            console.log('üîÑ Tentando iniciar servidor mesmo assim...\n');
            
            try {
                await this.iniciarServidor();
            } catch (serverError) {
                console.error('‚ùå Falha total na inicializa√ß√£o:', serverError.message);
                process.exit(1);
            }
        }
    }

    /**
     * Testar conectividade com GitHub (modo teste)
     */
    async testarConectividade() {
        console.log('üß™ MODO TESTE - VERIFICANDO CONECTIVIDADE GITHUB\n');
        
        try {
            const resultados = await this.githubUpdater.testarConectividade();
            
            const sucessos = resultados.filter(r => r.success).length;
            
            if (sucessos === resultados.length) {
                console.log('\nüéâ TODOS OS TESTES PASSARAM!');
                console.log('‚úÖ GitHub est√° acess√≠vel e configurado corretamente');
                console.log('üöÄ Sistema pronto para auto-updates\n');
            } else {
                console.log('\n‚ö†Ô∏è ALGUNS TESTES FALHARAM');
                console.log('üîß Verifique a configura√ß√£o do reposit√≥rio\n');
            }
            
            return sucessos === resultados.length;
            
        } catch (error) {
            console.error('‚ùå Erro nos testes:', error.message);
            return false;
        }
    }
}

// ‚úÖ EXECUTAR BASEADO NOS ARGUMENTOS
if (require.main === module) {
    const starter = new SystemStarter();
    const args = process.argv.slice(2);
    
    if (args.includes('--test')) {
        // Modo teste - s√≥ verificar conectividade
        starter.testarConectividade()
            .then(sucesso => {
                process.exit(sucesso ? 0 : 1);
            })
            .catch(error => {
                console.error('üí• Falha no teste:', error.message);
                process.exit(1);
            });
    } else {
        // Modo normal - iniciar sistema com verifica√ß√£o de updates
        starter.iniciar()
            .catch(error => {
                console.error('üí• Falha na inicializa√ß√£o:', error.message);
                process.exit(1);
            });
    }
}

module.exports = SystemStarter;