// ========================================
// SISTEMA DE ATUALIZA√á√ÉO VIA GITHUB
// Sistema de Demandas Governan√ßa TOP v2.0.0
// ========================================

const https = require('https');
const fs = require('fs');
const path = require('path');

// Configura√ß√£o para ambiente corporativo
// Ignorar verifica√ß√£o de certificado SSL APENAS para ambientes com proxy/firewall
if (!process.env.NODE_TLS_REJECT_UNAUTHORIZED) {
    process.env.NODE_TLS_REJECT_UNAUTHORIZED = '0';
    
    // Suprimir warning espec√≠fico do NODE_TLS_REJECT_UNAUTHORIZED em produ√ß√£o
    const originalEmitWarning = process.emitWarning;
    process.emitWarning = (warning, ...args) => {
        if (typeof warning === 'string' && warning.includes('NODE_TLS_REJECT_UNAUTHORIZED')) {
            // Warning suprimido - configura√ß√£o necess√°ria para ambientes corporativos
            return;
        }
        return originalEmitWarning.call(process, warning, ...args);
    };
}

// Configurar agent HTTPS para ambientes corporativos
const httpsAgent = new https.Agent({
    rejectUnauthorized: false,
    keepAlive: true,
    timeout: 30000
});

class GitHubUpdateSystem {
    constructor(config = {}) {
        // Configura√ß√£o do reposit√≥rio GitHub
        this.config = {
            owner: config.owner || 'kruetzmann2110', // seu usu√°rio GitHub
            repo: config.repo || 'demandas', // seu novo reposit√≥rio
            branch: config.branch || 'master',
            folder: config.folder || 'releases', // pasta onde ficam as atualiza√ß√µes
            token: config.token || null, // GitHub token (opcional para repos p√∫blicos)
            ...config
        };
        
        this.baseUrl = `https://api.github.com/repos/${this.config.owner}/${this.config.repo}`;
        this.rawUrl = `https://raw.githubusercontent.com/${this.config.owner}/${this.config.repo}/${this.config.branch}`;
    }

    /**
     * Fazer requisi√ß√£o para GitHub API
     */
    async makeGitHubRequest(url, options = {}) {
        return new Promise((resolve, reject) => {
            const headers = {
                'User-Agent': 'Sistema-Demandas-Updater/1.0',
                'Accept': 'application/vnd.github.v3+json',
                ...options.headers
            };

            // Adicionar token se dispon√≠vel
            if (this.config.token) {
                headers['Authorization'] = `token ${this.config.token}`;
            }

            console.log(`üîó GET ${url}`);

            const req = https.request(url, {
                method: options.method || 'GET',
                headers: headers,
                timeout: 30000,
                agent: httpsAgent  // Usar agent configurado para ambiente corporativo
            }, (res) => {
                let data = '';

                res.on('data', (chunk) => {
                    data += chunk;
                });

                res.on('end', () => {
                    console.log(`üì° Status: ${res.statusCode}`);
                    
                    try {
                        const result = {
                            statusCode: res.statusCode,
                            headers: res.headers,
                            data: res.statusCode === 200 ? JSON.parse(data) : data,
                            rawData: data
                        };
                        resolve(result);
                    } catch (parseError) {
                        // Se n√£o for JSON, retornar como texto
                        resolve({
                            statusCode: res.statusCode,
                            headers: res.headers,
                            data: data,
                            rawData: data
                        });
                    }
                });
            });

            req.on('error', (error) => {
                console.log(`‚ùå Erro na requisi√ß√£o: ${error.message}`);
                reject(error);
            });

            req.on('timeout', () => {
                req.destroy();
                reject(new Error('Timeout na requisi√ß√£o GitHub'));
            });

            req.end();
        });
    }

    /**
     * Baixar arquivo raw do GitHub
     */
    async downloadRawFile(filePath) {
        const url = `${this.rawUrl}/${this.config.folder}/${filePath}`;
        
        return new Promise((resolve, reject) => {
            console.log(`üì• Baixando: ${url}`);

            const req = https.request(url, {
                method: 'GET',
                headers: {
                    'User-Agent': 'Sistema-Demandas-Updater/1.0'
                },
                timeout: 30000,
                agent: httpsAgent  // Usar agent configurado para ambiente corporativo
            }, (res) => {
                let data = '';

                res.on('data', (chunk) => {
                    data += chunk;
                });

                res.on('end', () => {
                    console.log(`üì° Status: ${res.statusCode}`);
                    
                    if (res.statusCode === 200) {
                        console.log(`‚úÖ Baixado: ${filePath} (${data.length} bytes)`);
                        resolve({
                            success: true,
                            content: data,
                            size: data.length,
                            filePath: filePath
                        });
                    } else {
                        console.log(`‚ùå Falha no download: ${res.statusCode}`);
                        resolve({
                            success: false,
                            statusCode: res.statusCode,
                            error: `HTTP ${res.statusCode}`,
                            filePath: filePath
                        });
                    }
                });
            });

            req.on('error', (error) => {
                console.log(`‚ùå Erro no download: ${error.message}`);
                resolve({
                    success: false,
                    error: error.message,
                    filePath: filePath
                });
            });

            req.on('timeout', () => {
                req.destroy();
                resolve({
                    success: false,
                    error: 'Timeout',
                    filePath: filePath
                });
            });

            req.end();
        });
    }

    /**
     * Verificar vers√£o no GitHub
     */
    async verificarVersaoGitHub() {
        console.log('üîç Verificando vers√£o no GitHub...');
        
        try {
            const result = await this.downloadRawFile('versao.json');
            
            if (result.success) {
                try {
                    const versaoData = JSON.parse(result.content);
                    console.log(`üìã Vers√£o GitHub: ${versaoData.version}`);
                    console.log(`üìÖ Atualiza√ß√£o: ${versaoData.updated_at}`);
                    
                    return versaoData;
                } catch (parseError) {
                    console.error(`‚ùå Erro ao fazer parse do JSON: ${parseError.message}`);
                    console.log(`üìÑ Conte√∫do recebido: ${result.content.substring(0, 300)}...`);
                    return null;
                }
            } else {
                console.log(`‚ö†Ô∏è N√£o foi poss√≠vel acessar versao.json: ${result.error}`);
                return null;
            }
            
        } catch (error) {
            console.error(`üí• Erro na verifica√ß√£o de vers√£o: ${error.message}`);
            return null;
        }
    }

    /**
     * Listar releases/tags dispon√≠veis
     */
    async listarReleases() {
        console.log('üìã Listando releases dispon√≠veis...');
        
        try {
            const url = `${this.baseUrl}/releases`;
            const result = await this.makeGitHubRequest(url);
            
            if (result.statusCode === 200 && Array.isArray(result.data)) {
                console.log(`üìä Encontradas ${result.data.length} releases:`);
                
                result.data.slice(0, 5).forEach((release, index) => {
                    console.log(`   ${index + 1}. ${release.tag_name} - ${release.name}`);
                    console.log(`      üìÖ ${release.published_at}`);
                    if (release.prerelease) console.log('      ‚ö†Ô∏è Pre-release');
                });
                
                return {
                    success: true,
                    releases: result.data
                };
            } else {
                console.log(`‚ùå Erro ao listar releases: ${result.statusCode}`);
                return {
                    success: false,
                    error: `HTTP ${result.statusCode}`
                };
            }
            
        } catch (error) {
            console.log(`üí• Erro ao listar releases: ${error.message}`);
            return {
                success: false,
                error: error.message
            };
        }
    }

    /**
     * Baixar arquivos de atualiza√ß√£o
     */
    async baixarAtualizacoes(arquivos) {
        console.log(`üîÑ Baixando ${arquivos.length} arquivos do GitHub...`);
        
        const results = [];
        
        for (const arquivo of arquivos) {
            console.log(`\nüì• Processando: ${arquivo}`);
            
            try {
                const result = await this.downloadRawFile(arquivo);
                
                if (result.success) {
                    // Salvar arquivo localmente - APENAS na pasta correta (web/)
                    let localPath;
                    
                    if (arquivo.startsWith('web/')) {
                        // Para arquivos web/, manter a estrutura completa na pasta web
                        localPath = path.join(__dirname, '..', arquivo);
                    } else {
                        // Para backend, remover primeira pasta
                        localPath = path.join(__dirname, '..', arquivo.replace(/^[^/]+\//, ''));
                    }
                    
                    // Criar diret√≥rio se necess√°rio
                    const dir = path.dirname(localPath);
                    if (!fs.existsSync(dir)) {
                        fs.mkdirSync(dir, { recursive: true });
                    }
                    
                    // Salvar novo arquivo diretamente
                    fs.writeFileSync(localPath, result.content);
                    console.log(`‚úÖ Arquivo atualizado: ${localPath}`);
                    
                    results.push({
                        arquivo: arquivo,
                        success: true,
                        localPath: localPath,
                        size: result.size
                    });
                } else {
                    console.log(`‚ùå Falha no download: ${result.error}`);
                    results.push({
                        arquivo: arquivo,
                        success: false,
                        error: result.error
                    });
                }
                
                // Pausa entre downloads
                await new Promise(resolve => setTimeout(resolve, 500));
                
            } catch (error) {
                console.error(`üí• Erro com ${arquivo}: ${error.message}`);
                results.push({
                    arquivo: arquivo,
                    success: false,
                    error: error.message
                });
            }
        }
        
        const sucessos = results.filter(r => r.success).length;
        console.log(`\nüìä Resultados: ${sucessos}/${results.length} arquivos baixados`);
        
        return results;
    }

    /**
     * Comparar vers√µes (igual ao sistema anterior)
     */
    precisaAtualizar(versaoAtual, versaoGitHub) {
        if (!versaoGitHub) return false;
        
        const [majorA, minorA, patchA] = versaoAtual.split('.').map(Number);
        const [majorG, minorG, patchG] = versaoGitHub.split('.').map(Number);
        
        if (majorG > majorA) return true;
        if (majorG === majorA && minorG > minorA) return true;
        if (majorG === majorA && minorG === minorA && patchG > patchA) return true;
        
        return false;
    }

    /**
     * Executar verifica√ß√£o e atualiza√ß√£o completa
     */
    async verificarEAtualizarSistema() {
        console.log('\n========================================');
        console.log('üîç VERIFICANDO ATUALIZA√á√ïES NO GITHUB');
        console.log('========================================\n');
        
        const CURRENT_VERSION = '2.0.0'; // Vers√£o atual do sistema
        
        try {
            // 1. Verificar vers√£o no GitHub
            const versaoGitHub = await this.verificarVersaoGitHub();
            
            if (!versaoGitHub) {
                console.log('‚ö†Ô∏è GitHub n√£o acess√≠vel - continuando com vers√£o local');
                return false;
            }
            
            // 2. Comparar vers√µes
            const needsUpdate = this.precisaAtualizar(CURRENT_VERSION, versaoGitHub.version);
            
            if (!needsUpdate) {
                console.log('‚úÖ Sistema j√° est√° na vers√£o mais recente!');
                return false;
            }
            
            console.log(`üÜï NOVA VERS√ÉO DISPON√çVEL: ${versaoGitHub.version}`);
            console.log(`üìã Mudan√ßas: ${versaoGitHub.changelog || 'Melhorias e corre√ß√µes'}`);
            
            // 3. Baixar atualiza√ß√µes - AGORA ATUALIZA AMBOS OS FRONTENDS
            const arquivosParaBaixar = [
                'backend/server.js',     // Backend
                'web/js/app.js',        // JavaScript WEB
                'web/css/style.css',    // CSS WEB  
                'web/index.html'        // HTML WEB
            ];
            
            const arquivosAtualizados = await this.baixarAtualizacoes(arquivosParaBaixar);
            
            const sucessos = arquivosAtualizados.filter(a => a.success);
            
            if (sucessos.length > 0) {
                console.log('\n‚úÖ ATUALIZA√á√ïES APLICADAS COM SUCESSO!');
                console.log('üìÅ Arquivos atualizados:');
                sucessos.forEach(arquivo => console.log(`   ‚Ä¢ ${arquivo.arquivo}`));
                
                // 4. Atualizar arquivo de vers√£o local
                const localVersionFile = path.join(__dirname, '..', 'version.json');
                fs.writeFileSync(localVersionFile, JSON.stringify({
                    version: versaoGitHub.version,
                    updated_at: new Date().toISOString(),
                    changelog: versaoGitHub.changelog,
                    source: 'GitHub',
                    repository: `${this.config.owner}/${this.config.repo}`
                }, null, 2));
                
                console.log(`\nüéâ SISTEMA ATUALIZADO PARA VERS√ÉO ${versaoGitHub.version}!`);
                console.log(`üìã Fonte: GitHub (${this.config.owner}/${this.config.repo})`);
                return true;
            } else {
                console.log('‚ö†Ô∏è Nenhuma atualiza√ß√£o foi aplicada');
                return false;
            }
            
        } catch (error) {
            console.error('‚ùå Erro durante verifica√ß√£o de atualiza√ß√µes:', error.message);
            return false;
        }
    }

    /**
     * Testar conectividade com GitHub
     */
    async testarConectividade() {
        console.log('========================================');
        console.log('üß™ TESTANDO CONECTIVIDADE GITHUB');
        console.log('========================================\n');
        
        console.log(`üìã Reposit√≥rio: ${this.config.owner}/${this.config.repo}`);
        console.log(`üåø Branch: ${this.config.branch}`);
        console.log(`üìÅ Pasta: ${this.config.folder}\n`);
        
        const tests = [
            {
                name: 'Informa√ß√µes do reposit√≥rio',
                test: () => this.makeGitHubRequest(this.baseUrl)
            },
            {
                name: 'Listar releases',
                test: () => this.listarReleases()
            },
            {
                name: 'Download versao.json',
                test: () => this.verificarVersaoGitHub()
            }
        ];
        
        const results = [];
        
        for (const test of tests) {
            console.log(`üß™ ${test.name}...`);
            
            try {
                const result = await test.test();
                const success = result && (result.success !== false) && (result.statusCode === 200 || result.statusCode === undefined);
                
                console.log(`${success ? '‚úÖ' : '‚ùå'} ${test.name}: ${success ? 'OK' : 'Falhou'}\n`);
                
                results.push({
                    name: test.name,
                    success: success,
                    result: result
                });
                
            } catch (error) {
                console.log(`‚ùå ${test.name}: Erro - ${error.message}\n`);
                results.push({
                    name: test.name,
                    success: false,
                    error: error.message
                });
            }
        }
        
        const sucessos = results.filter(r => r.success).length;
        console.log(`üìä Resultado: ${sucessos}/${results.length} testes passaram`);
        
        if (sucessos === results.length) {
            console.log('üéâ GitHub est√° totalmente acess√≠vel!');
            console.log('üöÄ Pronto para implementar sistema de atualiza√ß√£o via GitHub');
        } else {
            console.log('‚ö†Ô∏è Alguns testes falharam - verifique configura√ß√£o');
        }
        
        return results;
    }
}

// ‚úÖ EXECUTAR SE CHAMADO DIRETAMENTE
if (require.main === module) {
    // Configura√ß√£o para o novo reposit√≥rio "demandas"
    const githubUpdater = new GitHubUpdateSystem({
        owner: 'kruetzmann2110', // seu usu√°rio GitHub
        repo: 'demandas', // seu novo reposit√≥rio
        branch: 'master',
        folder: 'releases'
        // token: 'ghp_xxxxxxxxxxxx' // GitHub token se necess√°rio
    });
    
    // Escolher que teste executar
    const args = process.argv.slice(2);
    
    if (args.includes('--test')) {
        githubUpdater.testarConectividade()
            .then(() => {
                console.log('\nüèÅ Teste de conectividade conclu√≠do!');
                process.exit(0);
            })
            .catch((error) => {
                console.error('üí• Falha no teste:', error.message);
                process.exit(1);
            });
    } else {
        githubUpdater.verificarEAtualizarSistema()
            .then(updated => {
                if (updated) {
                    console.log('\nüîÑ REINICIE O SISTEMA PARA APLICAR AS ATUALIZA√á√ïES');
                    process.exit(1);
                } else {
                    console.log('\n‚úÖ Continuando com sistema atual...');
                    process.exit(0);
                }
            })
            .catch(error => {
                console.error('üí• Erro cr√≠tico:', error);
                process.exit(0);
            });
    }
}

module.exports = GitHubUpdateSystem;